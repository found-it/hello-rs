name: Release-plz

on:
  push:
    branches:
      - main
  release:
    types:
    - published

permissions:
  contents: read

jobs:
  release-plz-release:
    if: ${{ github.repository_owner == 'found-it' }}
    name: Release-plz release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Run release-plz
        uses: release-plz/action@v0.5
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-plz-pr:
    if: ${{ github.repository_owner == 'found-it' }}
    name: Release-plz PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    concurrency:
      group: release-plz-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run release-plz
        uses: release-plz/action@v0.5
        with:
          command: release-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  upload-artifact:
    if: ${{ github.repository_owner == 'found-it' && github.event_name == 'release' }}
    name: Upload artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform:
        - { os: linux, arch: x86_64, on: ubuntu-latest, deps: linux }
    env:
      TARGET_OS: '${{ matrix.platform.os }}'
      TARGET_ARCH: '${{ matrix.platform.arch }}'
    runs-on: '${{ matrix.platform.on }}'
    steps:
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: build
        run: cargo build --release
      - name: 'Assemble hello-rs executable'
        run: |
          tag_name='${{ github.event.release.tag_name }}'
          [ -z $tag_name ] && tag_name='${{ github.event.repository.default_branch }}'

          ./hack/ci/assemble-release-assets.sh \
            protect-ctl \
            ${tag_name} \
            ${{ matrix.platform.os }}-${{ matrix.platform.arch }} \
            target/*/release

      - name: 'Upload protect-ctl to workflow run'
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: protect-ctl-${{ matrix.platform.os }}-${{ matrix.platform.arch }}
          path: |
            target/assets/*

      - name: 'Upload all release artifacts'
        run: |
          ./hack/ci/upload-release-assets.sh ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        if: ${{ github.event_name == 'release' }}
